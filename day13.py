from typing import List, Tuple, DefaultDict
from collections import defaultdict
from enum import Enum

RAW = r"""/->-\        
|   |  /----\
| /-+--+-\  |
| | |  | v  |
\-+-/  \-+--/
  \------/   """

PARTB_TEST_RAW = r"""/>-<\  
|   |  
| /<+-\
| | | v
\>+</ |
  |   ^
  \<->/"""


REAL_RAW = r"""                                /--------------------\                       /------------------------------------------------<-------\               
                                |         /----------+-----------------------+------------------------------------------------------\ |               
                                |         |          |                /------+-------------------------------------\                | |               
                                |         |          | /-->-----------+------+---------------------\               |                | |               
                  /-------------+---------+----------+-+--------------+------+---------------------+---------------+\               | |               
                  |             |         |          | |    /---------+------+----------\          |               ||               | |               
                  |             |         |    /-----+-+----+---------+------+----------+-------\  |               ||       /-------+\|               
    /-------------+----------\  |         |    |     | |    |         | /----+-------\  |       |  |               ||       |       |||               
    |             |          |  |         |    |     | |/---+---------+-+----+-------+--+-------+--+---------------++-----\ |       |||               
    |             |    /-----+--+---------+----+-----+-++---+-\ /-----+-+----+-------+--+-------+--+---------------++-----+-+-------+++-----\         
    |             |    |     |  |         |    |     | ||   | | |     | |    |       |/-+-------+--+--------\      ||     | |       |||     |         
    |             |    |     | /+---------+----+-----+-++--\| | |     | |    |    /--++-+---\   |  |        |      ||     | |       |||     |         
    |             |    |     | ||/--------+----+-----+-++--++-+-+-----+-+----+----+--++-+---+-\ |  |        |      ||     | |       |||     |         
 /--+-------------+----+-----+-+++--\     \----+-----+-++--++-+-+-----+-+----+----+--++-+---+-+-+--+--------+------++-----+-+-------/||     |         
 |  |   /---------+---\|     | |||  |          |     | ||  || | |     | |    |    |  || |   | | |  |        |      ||     | |        ||     |         
 |  |   | /-------+---++-----+-+++--+----------+-----+-++-\|| | |     | |    |    |  || |   | | |  |        |      ||     | \--------/|     |         
 |  |   | |       |   ||     | |||  |          |     | || ||| | |     | |    |    |  || |   | | |  |        |      ||     |           |     |         
 |  |   | |     /-+---++-----+-+++--+----------+-----+-++-+++\| |     | |    |    |  || |   | | |  |/-------+------++-----+-----------+-\   |         
 |  |   | |     | |   ||     | |||  |          |     | || ||||| |     | |    |    |  || |   | | | /++-------+------++-----+---------\ | |   |         
 |  |   | |     | |   ||     | |||  |  /-------+-----+-++-+++++-+-----+-+----+----+--++-+---+-+-+-+++-------+------++-----+-------\ | | |   |         
 |  |   | |     | |   ||     | |||  |  |       |     | || ||||| |     \-+----+----+--++-+---+-+-+-+++-------+------/|     |       | | | |   |         
 |  \---+-+-----+-+---++-----/ |||  |  |       |     | || ||||| |       |    |    |  ||/+---+-+-+-+++-------+-------+-----+-------+-+\| |   |         
 |      | |     | |   ||   /---+++--+--+-------+\    | || ||||| |       |    |    |  ||||   | | | |||       |       |     |       |/+++-+---+--\      
 |      | |     | |   ||   |   |||  |  |       ||    | ||/+++++-+-------+----+----+--++++---+\| | |||       |       |     |       ||||| |   |  |      
 \------+-+-----+-+---++---+---+++--/  |       ||    | |||||||| |       |    |    |  ||||   ||| | |||       |       |     |       ||||| |   |  |      
        | |   /-+-+---++---+---+++-----+-------++----+\|||||||| |       |    |    | /++++---+++-+-+++---\   |       |     |       ||||| |   |  |      
        | | /-+-+-+---++---+---+++-----+-------++-\  ||\+++++++-+-------+----+----+-+++++---+++-+-+/|/>-+---+-------+-----+----\  ||||| |   |  |      
        | | | | | |   |\---+---+++-----+-------++-+--++-++++++/ |       |    |    | |||||   ||| | | ||/-+---+-------+-----+----+--+++++-+---+--+----\ 
        | | | | | |   |    |   |||     |       || |  || ||||||/-+-------+--\ |    | ||\++---+++-+-+-+++-+---//------+-----+----+--+++++-+---+--+--\ | 
        | | | | | |   |   /+---+++-\   | /-----++-+--++-+++++++-+-------+--+-+----+-++-++---+++-+-+-+++-+----+------+\    |    |  ||||| |   |  |  | | 
        | |/+-+-+-+---+---++---+++-+---+-+-----++-+--++-+++++++-+-------+--+-+----+-++-++---+++-+-+-+++-+----+------++-\  |    |  ||||| |   |  |  | | 
        | ||| | | |   |   ||   \++-+---+-+-----++-+--++-+++/||| |       |  | |    | || ||   ||| | | ||| |    |      || |  |    |  ||||| |   |  |  | | 
      /-+-+++-+-+-+---+---++----++-+---+-+-----++-+--++-+++-+++-+-------+--+-+----+-++-++---+++-+-+-+++-+----+-\    || |  |    |  ||||| |   |  |  | | 
      | | ||| | | |   |   ||    || |   | |     || |  || ||| ||| |       |  | |    | || ||   ||| | | ||| |    | |    || |  |    |  ||||| |   |  |  | | 
      | | ||| | | |  /+---++---\|| |   | |     || |  || ||| ||| |       \--+-+----+-+/ ||  /+++-+-+-+++-+----+-+----++-+--+----+--+++++-+---+--+-\| | 
      | | ||| | | |  ||   ||   ||| |   | |  /--++-+--++-+++-+++-+----------+-+----+-+--++--++++-+-+-+++-+----+-+----++-+--+--\ |  ||||| |   |  | || | 
    /-+-+-+++-+-+-+--++---++---+++-+---+-+--+--++-+--++-+++-+++-+---\  /---+-+----+-+--++--++++-+-+-+++-+----+-+----++-+--+--+-+--+++++-+-\ |  | || | 
    | | | ||| | | |  ||   ||   ||| |   | |/-+--++-+--++-+++-+++-+---+--+---+-+----+-+--++--++++-+-+-+++-+----+-+----++-+--+--+-+--+++++-+-+-+\ | || | 
    | | | ||| | | |  ||  /++---+++-+---+-++-+--++-+--++-+++-+++-+---+--+---+-+----+-+--++--++++-+-+-+++-+----+-+----++-+-\| /+-+--+++++\| | || | || | 
    | | | ||| | | |  ||  |||   ||| |   | || |  || | /++-+++-+++-+---+--+-\ | |    | |  ||  |||| | | ||| |    | |    || | || || |  ||||||| | || ^ || | 
    | | | ||| | | |  ||  |||   ||| |   |/++-+--++-+-+++-+++-+++-+---+--+-+-+-+----+-+--++--++++-+-+-+++-+----+\|    || | || || |  ||||||| | || | || | 
    | | | ||| |/+-+--++--+++---+++-+---++++-+--++-+-+++-+++-+++-+---+--+-+-+\|    | |  ||  |||| | | ||| |    |||    || | || || |  ||||||| | || | || | 
    | | | ||| ||| |  ||  |||   ||| |   |||| |  || | |||/+++-+++-+---+--+-+-+++----+-+--++--++++-+-+-+++-+----+++----++-+-++-++-+--+++++++-+-++-+-++\| 
  /-+-+-+-+++-+++-+--++\ |||   ||| |   |||| | /++-+-+++++++-+++-+---+--+-+-+++--\ | \--++--++++-+-+-+++-/    |||    || | || || |  ||||||| | || | |||| 
  | | | | \++-+++-+--+++-+++---+++-+---++++-+-+++-+-++++++/ ||| |   |  | | ||\--+-+----++--++++-+-+-+++------+++----++-+-++-++-+--++++/|| | || | |||| 
  | | | |  || \++-+--+++-+++---+++-+---++++-+-+++-+-++/|||  ||| |  /+--+-+-++---+-+----++--++++-+-+-+++------+++----++-+-++-++-+--++++-++-+-++-+\|||| 
  | | | |  ||  || |  ||| ||\---+++-+---++++-+-++/ | || ||| /+++-+--++--+-+-++---+-+---\||  \+++-+-+-+++------+++----++-+-++-++-+--++++-++-+-++-++/||| 
 /+-+-+-+--++--++-+--+++-++----+++-+---++++-+\||  | || ||\-++++-+--++--+-+-++---+-+---+++---+/| | | |||      |||    || | || || |  |||| || | || || ||| 
 || | | |  ||  || |  ||| ||    ||| |   |||| ||||  | || ||  |||| |  ||  | | ||   | |   |||   | | |/+-+++------+++----++-+-++-++-+--++++-++-+-++\|| ||| 
 || | | |  ||  || |  ||| ||    ||| |   |||| ||||  | || ||  |||| |  ||  | | ||   | |   |||   | | ||| |||      |||    || | || || |  |||| || | ||||| ||| 
 || | | |  ||  || |  ||| ||   /+++-+---++++-++++--+-++-++--++++-+-\||  | | ||   | |   |||   | | ||| |||      |||    || | || || |  |||| || | ||||| ||| 
 || | | |  ||  || |  ||| ||   |||| |   |||| |||| /+-++-++--++++-+-+++\ | | ||   | |   |||   | | ||| |||      |||    || | || || |  |||| || | ||||| ||| 
 || | | |  ||  || |  ||| ||   |||| |   |||| |||| || || ||  |||| | |||| | | ||   | |   |||   | | ||| \++------+++----++-+-++-++-+--++++-+/ | ||||| ||| 
 || | | |  ||  || |  ||| ||   |||| |   |||| |||| || || ||  |||| | |||| | | ||   | |   |||   | | |||  ||      |||    || | || || |  |||| |  | ||||| ||| 
 || | | |  ||  || |  ||| ||   |||| |   |||| |||| || || ||  |||| | |||| | | ||   | | /-+++---+-+\|||  ||      |||    || | || || |  |||| |  | ||||| ||| 
 || | ^ |  ||  || |  ||| ||   |||| |/--++++-++++-++-++-++--++++-+-++++-+-+-++---+-+-+-+++--\| |||||/-++------+++----++-+-++-++-+--++++\|  | ||||| ||| 
 || | | |  ||  || |  ||| ||   |||| ||  |||| |||| || || ||  |||| | |||| | | ||   | | | |||  || |||||| ||      |||    || | || \+-+--+++++/  | ||||| ||| 
 || | | |  ||  || |  ||| ||   ||||/++--++++-++++-++-++-++--++++-+-++++-+-+-++---+-+-+-+++--++-++++++-++-----\|||    || | ||  | |  |||||   | ||||| ||| 
 || | | |  ||  || |  ||| ||   |||||||/-++++-++++-++-++-++--++++-+-++++-+-+-++---+-+-+-+++--++-++++++-++-----++++----++-+-++--+-+--+++++---+-+++++\||| 
 |\-+-+-+--++--++-+--++/ ||   |||||||| |||| |||| || || ||  |||| |/++++-+-+-++---+-+-+-+++--++-++++++-++-----++++----++-+-++--+-+--+++++---+-+++++++++\
 |  | | |  ||  || |  ||  ||   |||||||| |||| |||| || || ||  |||| |||||| | | ||   |/+-+-+++--++-++++++-++--\  ||||    || | ||  | |  |||||   | ||||||||||
 |  | | |  ||  ||/+--++--++---++++++++-++++-++++-++-++-++--++++-++++++-+-+-++---+++-+-+++--++-++++++-++--+--++++----++-+-++-\| |  |||||   | ||||||||||
 |  | | |  ||/-++++--++--++---++++++++-++++-++++-++-++-++--++++-++++++-+-+-++---+++-+-+++--++-++++++-++--+--++++---\|| | || || |  |||||   | ||||||||||
 |  | | |  ||| ||||  ||  ||   |||||||| |||| |||| || || ||  |||| |||||| | | ||   ||| | |||  || |||||| || /+--++++--\||| | || || |  |||||   | ||||||||||
 |  | | |  ||| ||||  ||  || /-++++++++-++++-++++-++-++-++--++++-++++++-+-+-++---+++-+-+++--++-++++++-++-++--++++--++++-+-++-++-+\ |||||   | ||||||||||
 |  | | |/-+++-++++--++--++-+-++++++++\|||| |||| || || ||  |||| |||||| | | ||   ||| | |||  || |||||| v| ||  ||||  |||| | || || || |||||   | ||||||||||
 |  | | || ||| ||||  ||  \+-+-+++++++++++++-++++-++-++-++--++++-++++++-+-+-++---+++-+-+++--++-++++++-++-++--++++--++++-+-/| v| || |||||   | ||||||||||
 |  | | || ||| ||||  ||   | | |||||||||||||/++++-++-++-++--++++-++++++-+-+-++---+++-+\|||  || |||||| || ||  ||||  |||| |  | || || |||||   | ||||||||||
 |  | | || ||| ||||  ||   | | |||||||||||||||||| || || ||  |||| ||||||/+-+-++---+++-+++++--++-++++++-++-++--++++--++++-+-\| || || |||||   | ||||||||||
 |  | | || ||| ||||  ||   | | |||||||||||||||||| || || ||  |||\-++++++++-+-/|  /+++-+++++--++-++++++-++-++\ ||||  ||||/+-++-++-++-+++++\  | ||||||||||
 |  | | || ||| ||||  ||   | | ||\+++++++++++++++-++-+/ ||  |||  |||||||| |  |  |||| |||||  || |||||| || ||| ||||  |||||| || || || ||||||  | ||||||||||
 |  | | || ||| ||||  ||   | | || ||||||||||||||| || |  ||  |||  |||||||| |  |  |||| |||||  || |||||| || ||| ||||  |||||| || || || ||||||  | ||||||||||
 |  | | ||/+++-++++--++---+-+-++-+++++++++++++++\||/+--++--+++--++++++++-+--+--++++\|||||  || |||||| || ||| ||||  |||||| || || || ||||||  | ||||||||||
 |  | | |||||| ||||  ||   | | || ||||||||||||||||||||  ||  |||  |||||||| |  |  |||||\++++--++-+/|||| || ||| ||||  |||||| || || || ||||||  | ||||||||||
 |  | | |||||| ||||  ||   | | || ||||||||||||||||||||  ||  |||  |||||||| |  |  ||||| ||||  || | |||| || ||| ||||  |||||| || || || ||||||  | ||||||||||
 |  | | |||||| ||||  ||   | | || ||||||||||||||||||||  ||  |||  |||||||| |  |  ||\++-++++--++-+-++++-++-+/| ||||  |||||| || || || ||||||  | ||||||||||
 |  | | |||||| ||\+--++---+-+-++-++++++++++++++++++++--++--+++--++++++++-+--+--++-++-++++--++-+-++++-++-+-+-++++--++++++-++-/| || ||||||  | ||||||||||
 |  | | |||||| |\-+--++---+-+-++-++++++++++++++++++++--++--++/  |||||||| |  |  || || ||||  || | |||| || | | |\++--++++++-++--+-++-++++++--+-++++++/|||
 |  | | |||||| |  |  ||   | | || \+++++++++++++++++++--++--++---++++++++-+--+--++-++-++++--++-/ |||| || | | | ||  |||||| ||  | || ||||||  | |||||| |||
 |  | | |||||| |  |  ||   | | ||  |||||||||||||||||||  ||  ||   |||||||| |  |  || || ||||  ||   |||| || | | | ||  |||||| ||  | || ||||||  | |||||| |||
/+--+-+-++++++-+--+-\||   | | ||  |||||||||||||||||||  ||  ||   |||||||| |  |  || || ||||  ||   |||| || | | | ||  |||||| ||  | || ||||||  | |||||| |||
||  | | \+++++-+--+-++/   | | ||  |||||||||||||||||||  ||  ||   |||||||| |  |  || || ||||  ||   |\++-++-+-+-+-++--++++++-++--+-++-++++++--+-++/||| |||
||  | |  ||||| |  | ||   /+-+-++--+++++++++++++++++++--++--++---++++++++-+--+--++-++-++++--++---+-++-++-+-+-+-++--++++++-++\ | || ||||||  | || ||| |||
||  | |  ||||| |  | ||   || | ||  |||||||||||||||||||  ||  ||   ||||||v| |  |  || \+-++++--+/   | || || | | | ||  |||||| ||| | || ||||||  | || ||| |||
||  | |  ||||| |  \-++---++-+-++--+++++++++++++++++++--++--++---++++++++-+--+--++--+-++++--+----+-++-++-+-+-+-++--++/||| ||| | || ||||||  | || ||| |||
||/-+-+--+++++-+----++---++-+-++--+++++++++++++++++++--++--++-\ |||||||| |  |  ||  | ||||  |    |/++-++-+-+-+-++--++-+++-+++-+-++-++++++--+\|| ||| |||
||| |/+--+++++-+----++---++-+-++-\|||||||||||||||||||  ||  || | |||||||| |  |  ||  | ||||  |    |||| || | | | ||  || ||| ||| | || ||||||  |||| ||| |||
||| |||  |||||/+----++--\|| | \+-++++++++++++++++++++--++--++-+-++/||||| |  |  ||  | ||||  |    |||| || | | | ||  || ||| ||| | || ||||||  |||| ||| |||
||| |||  ||\++++----++--+++-+--+-++++++++++++++++++++--++--++-+-++-+++++-+--+--++--+-++++--+----++++-++-+-+-+-++--++-++/ ||| | || ||||||  |||| ||| |||
||| v||  || ||||    ||  ||| |  | ||||||||||||||||||||  ||  |\-+-++-+++++-+--+--++--+-+++/  |    |||| || | | | ||  || ||  ||| | || ||||||  |||| ||| |||
||| |||  || ||||    ||  ||| |  | ||||||||||||||||||||  ||  |  | || ||||| |  |  ||  | |||   |    |||| || | | | ||  || ||  ||| | || ||||||  |||| ||| |||
||| \++--++-++++----++--+++-+--+-++++++++++++++++++++--++--+--+-++-+/||| |  |  ||  | |||   |    |||| |\-+-+-+-++--++-++--+++-+-++-++++++--++++-+++-+/|
|||  || /++-++++--\ ||  ||| |  | ||||||||||||||||||||  |\--+--+-++-+-+++-+--+--++--+-+++---+----++++-+--+-+-+-++--++-++--+/| | || ||||||  |||| ||| | |
|||  || ||| ||||  | ||  |||/+--+-++++++++++++++++++++--+---+--+-++-+-+++-+--+--++--+-+++--\|    |||| |  | | | ||  || ||  | | | || ||||||  |||| ||| | |
|||  || ||| ||||  | ||  |||||  | ||||||||||||||||||||  |   |  | || | ||| |  |  ||  | ||\--++----++++-+--+-+-+-++--++-++--+-+-+-++-+++/||  |||| ||| | |
||\--++-+++-++++--+-++--+++++--+-++++++++++++++++++++--+---+--/ || | |||/+--+--++--+-++---++----++++-+--+-+-+-++\ || ||  | | | || ||| ||  |||| ||| | |
||   || ||| ||||  | ||  |||||  | ||||||||||||||||||||  |   |    || | |||||  |  ||  | ||   ||    |||| |  | | | ||| || ||  | | | || ||| ||  |||| ||| | |
||   || ||| ||||  | ||  |||||  | ||||||||||||||||||||  |   |    || | |||||  |  ||  | ||   ||    |||| |  | | | ||| || ||  | | | || |\+-++--++++-/|| | |
||  /++-+++-++++--+-++--+++++-\| |||||||||||||||||||\--+---+----++-+-++++/  |  ||  | ||   ||    |||| |  | | | ||| || ||  | | | || | | ||  ||||  || | |
||  ||| ||\-++++--+-++--+++++-++-+++++++++++++++/|||   |   |    || | ||||   | /++--+-++---++----++++-+--+-+-+-+++-++-++--+-+-+\|| | | ||  ||||  || | |
||  ||| || /++++--+-++--+++++-++-+++++++++++++++\|||   |   |    || | ||||   | |||  | ||   ||    |||| |  | | | ||| || ||  | | |||| | | ||  ||||  || | |
||  ||| || |||||  | ||  ||||| || |||||||||||||||||||   |/--+----++-+-++++---+-+++--+\||   ||    |||| |  | | | ||| || ||  | | |||| | | ||  ||||  || | |
||  ||| || |||||  | ||  ||||| || |||||||||||||\+++++---++--+----++-+-++++---+-++/  ||||   ||    |||| |  | | | ||| || ||  | | |||| | | ||  ||||  || | |
||  ||| || |||||  | ||  ||||| || ||||||||||||| \++++---++--+----++-+-++++---+-++---++++---++----/\++-+--+-+-+-+++-++-++--+-+-++++-+-+-++--+/||  || | |
||  ||| || |||\+--+-++--/|||| || |||||||||||||  ||||   ||  |    || | ||||   | ||   ||||   ||      || |  | | | ||| || ||  | | |||| | | ||  | ||  || | |
||  ||| || ||| |  | ||   |||| || |||||||||||||  ||||   ||  |    || | ||\+---+-++---++++---++------++-+--+-+-+-+++-++-++--+-+-++++-+-+-++--/ ||  || | |
||  ||| || ||| |  | ||   |||| || |||||||||||||  ||||   ||  |    \+-+-++-+---+-++---++++---++------++-+--+-+-+-+++-++-++--+-+-++++-+-+-++----/|  || | |
||  ||| |\-+++-+--+-++---++++-++-+++++/|||||||  ||||   ||  |     | | || |   | ||   ||||   ||      || |  | | | ||| || ||  | | |||| | | ||     |  || | |
\+--+++-+--+++-+--+-/|   |\++-++-++/|| |||\+++--++++---++--+-----+-+-++-+---+-++---++++---++------++-+--+-+-+-+++-++-++--+-+-++++-+-+-++-----/  || | |
 |  ||| |  ||| |  |  |   | || || || || ||| |||/-++++---++--+-----+-+-++-+---+-++---++++---++------++-+--+-+-+-+++-++-++--+-+-++++-+-+-++\       || | |
 |  ||| |  ||| |  |  |   | || || || || |\+-++++-++++---++--+-----+-+-++-+---+-++---++++---++------++-+--+-+-+-/|| || ||  | | |||| | | |||       || | |
 | /+++-+--+++-+--+--+---+-++-++-++-++-+-+\|\++-++++---++--+-----+-+-++-+---+-++---++++---++------++-+--+-+-+--++-++-++--+-+-/||| | | |||       || | |
 | |||| \--+++-+--/  |   | || || || || \-+++-++-++++---++--+-----+-+-++-+---+-++---++++---++------++-+--+-+-+--++-++-++--+-+--+++-/ | |||       || | |
 | |\++----+++-+-----+---+-++-/| || \+---+++-++-++++---++--+->---+-+-++-+---+-++---++++---+/      || |  | | |  || || ||  | |  |||   | |||       || | |
 | | ||    ||| \-----+---+-++--+-++--+---+++-++-++++---++--+-----+-+-++-+---/ ||   ||||  /+-------++-+--+-+-+--++-++-++--+-+--+++---+-+++-------++\| |
 | | ||    |||       |   | ||  | ||  |   ||| || ||||   ||  |     | | || |     ||   ||||  ||       \+-+--+-+-+--++-++-++--+-+--+++---/ |||       |||| |
 | | ||    |\+-------+---+-++--+-++--+---+++-++-++/|   ||  |     | | || |     ||   ||||  ||        | |  | | |  || || |\--+-+--+++-----+/|       |||| |
 | | ||    | |       |   | ||  | ||  |   ||| || || |   |\->+-----+-+-++-+-----++---+/||  ||        | |  | | |  || || |   | |  ^||     | |       |||| |
 | | \+----+-+-------+---+-++--+-/|  |/--+++-++-++-+---+---+-----+-+-++-+-----++---+-++--++--------+-+--+-+-+--++-++\|   | |  |||     | |       |||| |
 | |  |    | |       |   | |\--+--+--++--+++-++-++-+---+---+-----+-+-++-+-----++---+-++--++--------+-+--+-+-+--++-++++---+-+--++/     | |       |||| |
 | |  |    | |       |   \-+---+--+--++--+++-++-++-+---+---+-----+-+-++-+-----++---+-++--++--------+-+--+-+-+--++-++++---+-/  ||      | |       |||| |
 | |  |    | |       |     |   |  |  \+--+++-++-++-+---+---+-----+-+-++-+-----++---+-++--++--------+-+--+-+-+--++-++++---+----++------+-+-------+/|| |
 | |  |    | |       |     |   |  |   |  ||| || || |   |  /+-----+-+-++-+-----++---+-++--++--------+-+--+-+-+--++-++++---+----++------+-+--\    | || |
 | |  |    \-+-------+-----+---+--+---+--+++-++-/\-+---+--++-----+-+-/| |     ||   | ||  ||        | |  | | |  || ||||   |    ||      | |  |    | || |
 | |  \------+-------+-----+---+--+---+--+++-++----+---+--++-----+-+--+-+-----++---+-++--++--------+-+--+-+-+--/| ||||   |    ||      | |  |    | || |
 | |      /--+-------+-----+---+--+---+--+++-++----+---+--++-----+-+-\| |     \+---+-++--++--------+-+--+-+-+---+-++++---+----/|      | |  |    | || |
 | |      |  |       |     |   |  |   |  ||| ||    \---+--++-----+-+-++-+------+---/ ||  ||        | |  | | |   | ||||   |     |      | |  |    | || |
 | |    /-+--+-------+-----+---+--+---+--+++-++----\   |  ||     \-+-++-+------+-----++--++--------+-+--+-+-+---+-++++---+-----+------+-+--+----+-++-/
 | |    | |  |       |     |   |  \---+--+++-++----+---+--++-------+-++-+------+-----++--++--------+-+--+-+-/   | ||||   |     |      | |  |    | ||  
 | |    | |  |       \-----+---/   /--+--+++-++---\|   |  ||       | || |      |     ||  ||        | |  | |     | ||||   |     |      | |  |    | ||  
 | |    | |  |             |       |  |  ||| ||   ||   |  |\-------+-++-+------+-----+/  ||        | \--+-+-----+-++++---+-----/      | |  |    | ||  
 | |    | |  |             |       |  |  ||| ||   ||   |  \--------+-++-+------+-----+---++--------+----+-+-----+-++++---+------------+-+<-/    | ||  
 | |    | |  |             |       |  |  ||| ||   ||   |           | || |      |     |   ||        |    | |     | ||||   |            | |       | ||  
 | |    | |  |             |       |  |  ||\-++---++---+-----------+-++-+------+-----/   \+--------+----+-+-----+-++++---+------------+-+-------+-/|  
 | |    | |  |             |       |  \--++--++---++---+-----------+-++-+------+----------+--------+----+-+-----+-++/|   |            | |       |  |  
 | |    | |  |             |       |     \+--++---++---+-----------+-++-+------+----------+--------+----+-+-----+-++-/   |            | |       |  |  
 | |    | |  |             |       |    /-+--++---++---+-----\     | || |      |          |        |    | |     | ||     |            | |       |  |  
 | |    | |  |             \-------+----+-+--++---++---+-----+-----+-++-+------+----------/        |    | |     | ||     |            | |       |  |  
 | |    | |  |                     |    | |  ||   ||   |     |     | || |   /--+----------\        |    | |     | ||     |            | |       |  |  
 | |    | |  |                     |    | |  ||   ||   |     |     | || |   |  |          |        |    \-+-----+-/|     |            | |       |  |  
 | |    | |  |                     |    | |  ||   ||   \-----+-----+-++-+---+--+----------+--------+------+-----+--+-----+------------+-+-------+--/  
 | |    | \--+---------------------+----+-+--++---++---------+-----+-/| |   |  |          |        |      |     |  |     |            | |       |     
 \-+----+----+---------------------+----+-+--/|   ||         |     \--+-+---+--+->--------+----->--+------+-----+--+-----+---------<--+-+-------/     
   |    |    |                     |    | |   \---++---------+--------+-+---+--+----------+--------+------+-----+--+-----+------------+-/             
   \----+----+---------------------+----+-/       ||         |        \-+---+--+----------+--------+------+-----+--+-----/            |               
        |    |                     |    \-----<---++---------/          \---+--+----------+--------+------+-----/  |                  |               
        |    \---------------------+--------------++------------------------+--+----------+--------+------+--------/                  |               
        |                          |              ||                        |  |          |        |      |                           |               
        \--------------------------+--------------+/                        \--+----------/        \------+---------------------------/               
                                   \--------------/                            \--------------------------/                                           """

class State:
    ALIVE = 1
    DEAD = 0

class Direction:
    UP = 0
    LEFT = 1
    DOWN = 2
    RIGHT = 3
    
class Cart:

    DIRECTION_CHANGE_LOOKUP = {

        ('/', Direction.LEFT) : Direction.DOWN,
        ('/', Direction.RIGHT) : Direction.UP,
        ('/', Direction.UP) : Direction.RIGHT,
        ('/', Direction.DOWN) : Direction.LEFT,

        ('\\', Direction.RIGHT) : Direction.DOWN,
        ('\\', Direction.LEFT) : Direction.UP,
        ('\\', Direction.UP) : Direction.LEFT,
        ('\\', Direction.DOWN) : Direction.RIGHT,

        ('-', Direction.LEFT) : Direction.LEFT,
        ('-', Direction.RIGHT) : Direction.RIGHT,
        ('|', Direction.UP) : Direction.UP,
        ('|', Direction.DOWN) : Direction.DOWN   
    }

    def __init__(self, direction, x, y, id):
        self.direction = direction
        self.x = x
        self.y = y
        self.crossroad_counter = 0
        self.state = State.ALIVE
        self.id = id

    def __repr__(self):
        return str(self.direction) + ":" + str((self.x, self.y))

    def __eq__(self, other):
        return self.id == other.id

    def step(self, direction):

        if direction == Direction.LEFT:
            self.x -= 1
        elif direction == Direction.RIGHT:
            self.x += 1
        elif direction == Direction.UP:
            self.y -= 1
        elif direction == Direction.DOWN:
            self.y += 1
        self.direction = direction
        pass

    def change_direction(self) -> int:
        x = (- self.crossroad_counter) % 3
        return (self.direction + x - 1 ) % 4

    def move(self, track) -> Tuple[int, int]:
        track_piece = track[self.y][self.x]
        if track_piece == '+':
            self.crossroad_counter += 1
            next_direction = self.change_direction()
            self.step(next_direction)
        else:
            next_direction = Cart.DIRECTION_CHANGE_LOOKUP[(track_piece, self.direction)]
            self.step(next_direction)
        return (self.x, self.y)


def parse_track(track) -> List[Cart]:
    car_parser = defaultdict(lambda: ("", -1))
    car_parser["<"] = "-", Direction.LEFT
    car_parser[">"] = "-", Direction.RIGHT
    car_parser["^"] = "|", Direction.UP
    car_parser["v"] = "|", Direction.DOWN
    carts = dict()
    for y, row in enumerate(track):
        for x, txt in enumerate(row):
            replacement_string, direction = car_parser[txt]
            if replacement_string != "":
                carts[(x,y)] = (replacement_string, direction)
    
    my_carts = list()
    for i,v in enumerate(carts):
        x, y = v
        replacement_string, direction = carts[v]
        track[y][x] = replacement_string
        my_carts.append(Cart(direction, x, y, i))

    return my_carts


lines = REAL_RAW.splitlines()
track = [list(x) for x in lines]
print(track)
carts = parse_track(track)
cart_tracker = defaultdict(list)
for c in carts:
    l = cart_tracker[(c.x, c.y)]
    l.append(c)

end_loop = False
while(not end_loop):
    carts = sorted(carts, key=lambda cart: cart.x + cart.y * 10000)

    for c in carts:
        if c.state == State.ALIVE:
            l = cart_tracker[(c.x, c.y)]
            l.remove(c)
            c.move(track)
            new_l = cart_tracker[(c.x, c.y)]
            new_l.append(c)
            if (len(cart_tracker[(c.x, c.y)]) > 1):
                # collision!!
                print(c.x, c.y)
                l = cart_tracker[(c.x, c.y)]
                for crashed_carts in l:
                    crashed_carts.state = State.DEAD
                cart_tracker[(c.x, c.y)] = list()
    
    crashed = [x for x in carts if x.state == State.DEAD]
    for c in crashed:
        carts.remove(c)

    if len(carts) == 1:
        print (carts[0])
        end_loop = True
    

